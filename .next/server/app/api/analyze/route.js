"use strict";(()=>{var e={};e.id=652,e.ids=[652],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},3023:e=>{e.exports=import("@google/generative-ai")},4036:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{originalPathname:()=>m,patchFetch:()=>c,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>d});var s=a(9303),n=a(8716),o=a(670),i=a(5247),l=e([i]);i=(l.then?(await l)():l)[0];let u=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analyze/route",pathname:"/api/analyze",filename:"route",bundlePath:"app/api/analyze/route"},resolvedPagePath:"/home/abhijeet/workspace/POC/faucet-image/faucet-finder-web/src/app/api/analyze/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:h}=u,m="/api/analyze/route";function c(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:d})}r()}catch(e){r(e)}})},5247:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{POST:()=>d});var s=a(3023),n=a(7070),o=a(2048),i=a.n(o),l=a(5315),c=a.n(l),u=e([s]);s=(u.then?(await u)():u)[0];let h=`You are an expert plumbing inventory assistant. 
You have access to a specific catalog of faucet images (provided in context) with filenames. 
Your job is to visually compare a user-provided photo against this catalog 
and identify the specific catalog items that match best. 
Prioritize the faucet silhouette and primary shape (spout arc, handle count, mounting style) 
before considering secondary cues like finish, hardware details, or branding. 
When shapes feel close, refine the comparison by highlighting smaller distinguishing traits 
so the user understands why each candidate was chosen. 
If you do not have any DIRECT matches, respond with the best matches in array and include a helpful message.
Always respond with JSON that follows this schema exactly:
{
  "message": "<optional text to the user>",
  "matches": [
    {
      "filename": "<catalog filename>",
      "title": "<title or empty string>",
      "brand": "<brand or empty string>",
      "color": "<color or empty string>",
      "confidence": <number between 0 and 1>,
      "reasoning": "<short explanation>"
    }
  ]
}
Return exactly three entries in the matches array (sorted by confidence, 
highest first) and only reference filenames that exist in the provided catalog. 
Do not output any explanation outside of this JSON. 
You can also ask questions to user to better filter your results.`,m=[".png",".jpg",".jpeg"],g=null,f=null;function p(){if(f)return f;let e=c().join(process.cwd(),"public/image_metadata.json");if(!i().existsSync(e))return console.warn("Metadata file not found:",e),{};try{let t=i().readFileSync(e,"utf-8"),a=JSON.parse(t),r={};for(let[e,t]of Object.entries(a))r[e]={Title:t.Title||"",Brand:t.Brand||"",VarDim_Color:t.VarDim_Color||"",VarDim_ColorCode:t.VarDim_ColorCode||""};return f=r,r}catch(e){return console.error("Error loading metadata:",e),{}}}async function d(e){try{let t;let a=process.env.GOOGLE_API_KEY;if(!a)return n.NextResponse.json({error:"GOOGLE_API_KEY environment variable is not set"},{status:500});let r=await e.formData(),o=r.get("message"),l=r.get("image"),u=r.get("history");if(!o&&!l)return n.NextResponse.json({error:"Please provide a message or an image"},{status:400});let d=new s.GoogleGenerativeAI(a).getGenerativeModel({model:"gemini-2.0-flash-lite"}),f=[];f.push({text:h});let y=function(){if(g)return g;let e=c().join(process.cwd(),"public/catalog-images");if(!i().existsSync(e))return console.warn("Catalog directory not found:",e),[];let t=p(),a=[];for(let s of i().readdirSync(e).sort()){var r;let n=c().extname(s).toLowerCase();if(!m.includes(n))continue;let o=c().join(e,s);if(!i().statSync(o).isFile())continue;let l=i().readFileSync(o).toString("base64"),u=".png"===n?"image/png":"image/jpeg",p=(r=t[s])&&0!==Object.keys(r).length?JSON.stringify(r):"No additional metadata provided.";a.push({text:`Catalog Image: ${s}
Metadata: ${p}`}),a.push({inlineData:{mimeType:u,data:l}})}return console.log(`Loaded ${a.length/2} catalog images`),g=a,a}();if(0===y.length)return n.NextResponse.json({error:"No catalog images found. Please add images to the catalog."},{status:500});if(f.push(...y),u)try{for(let e of JSON.parse(u))"user"===e.role?(e.text&&f.push({text:`User: ${e.text}`}),e.imageUrl&&f.push({text:"User uploaded an image of a faucet."})):"assistant"===e.role&&(e.assistantMessage&&f.push({text:`Assistant: ${e.assistantMessage}`}),e.matches&&e.matches.length>0&&f.push({text:`Assistant found matches: ${JSON.stringify(e.matches)}`}))}catch{}if(o?f.push({text:`User: ${o}`}):l&&f.push({text:"User: Find the best match for this faucet from the catalog."}),l){let e=await l.arrayBuffer(),t=Buffer.from(e).toString("base64"),a=l.type||"image/png";f.push({inlineData:{mimeType:a,data:t}})}let x=await d.generateContent(f),b=(await x.response).text();(b=b.trim()).startsWith("```json")&&(b=b.slice(7)),b.startsWith("```")&&(b=b.slice(3)),b.endsWith("```")&&(b=b.slice(0,-3)),b=b.trim();try{t=JSON.parse(b)}catch{return console.error("Failed to parse response:",b),n.NextResponse.json({error:"Failed to parse model response",rawResponse:b},{status:500})}if(!t.matches||!Array.isArray(t.matches))return n.NextResponse.json({error:"Invalid response structure from model",rawResponse:b},{status:500});let w=p();return n.NextResponse.json({message:t.message||"",matches:t.matches.map(e=>{let t=w[e.filename]||{};return{filename:e.filename,title:e.title||t.Title||"",brand:e.brand||t.Brand||"",color:e.color||t.VarDim_Color||"",confidence:"number"==typeof e.confidence?e.confidence:0,reasoning:e.reasoning||""}})})}catch(e){return console.error("Error in analyze API:",e),n.NextResponse.json({error:e instanceof Error?e.message:"An unexpected error occurred"},{status:500})}}r()}catch(e){r(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(4036));module.exports=r})();